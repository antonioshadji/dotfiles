#!/usr/bin/env bash
# shellcheck disable=SC1091,SC1090

# Kiro CLI pre block. Keep at the top of this file.
[[ -f "${HOME}/Library/Application Support/kiro-cli/shell/bashrc.pre.bash" ]] && builtin source "${HOME}/Library/Application Support/kiro-cli/shell/bashrc.pre.bash"

# https://github.com/koalaman/shellcheck/wiki/SC1090
# shellcheck disable=SC1090,SC1091
# vim: set foldmarker={{,}} foldlevel=99 foldmethod=marker :

# profile start time start {{
DEBUG=0
if [[ $DEBUG == 1 ]]; then
  PS4='+ $(date "+%s.%N")\011 '
  exec 3>&2 2>/tmp/bashstart.$$.log
  set -x
fi
# }}

# create log file for errors
# shows output on console and redirects to console
# exec 2> >(tee -a setup$(date '+%Y%m%d-%H%M%S').log >&2)

# Bash Reference Manual {{
# https://www.gnu.org/software/bash/manual/bash.html

# Notes By Balaji S. Srinivasan (balajis@stanford.edu)
# Concepts:
#    1) .bashrc is the *non-login* config for bash, run in scripts and after
#        first connection.
#    2) .bash_profile is the *login* config for bash, launched upon first connection.
#    3) .bash_profile imports .bashrc, but not vice versa.
# End Notes By Balaji S. Srinivasan (balajis@stanford.edu)


# Do 'man bashrc' for the long version or see here:
# https://www.gnu.org/software/bash/manual/bash.html#Bash-Startup-Files
# http://en.wikipedia.org/wiki/Bash#Startup_scripts
# https://www.gnu.org/software/bash/manual/bash.html#Conditional-Constructs
# [[…]]
# [[ expression ]]
# Return a status of 0 or 1 depending on the evaluation of the conditional
# expression *expression*. Expressions are composed of the primaries described
# below in Bash Conditional Expressions.
# ******************************************************************************
# the &&, ||, <, and > operators work within a [[ ]] test, despite giving an
# error within a [ ] construct.
# ******************************************************************************
# filename expansion === globbing ; disable with -f
# Word splitting and filename expansion are not performed on the words between
# the [[ and ]]; tilde expansion, parameter and variable expansion,
# arithmetic expansion, command substitution, process substitution, and
# quote removal are performed.
# Conditional operators such as ‘-f’ must be unquoted to be recognized as primaries.

# https://www.gnu.org/software/bash/manual/bash.html#Bash-Builtins
# Evaluate a conditional expression expr and return a status of 0 (true) or 1 (false).
# Each operator and operand must be a separate argument.
# Expressions are composed of the primaries described below in Bash Conditional Expressions.
# https://www.gnu.org/software/bash/manual/bash.html#Bash-Conditional-Expressions
# https://www.gnu.org/software/bash/manual/bash.html#Shell-Arithmetic
# }}

# If not running interactively, don't do anything
# -z = True if the length of string is zero.
[ -z "$PS1" ] && return

# set vi mode to edit like vim
# insert mode by default esc to go to command mode
set -o vi

# {{ History setup
# See:  http://www.ukuug.org/events/linux2003/papers/bash_tips/

# don't put duplicate lines or lines starting with space in the history.
# See bash(1) for more options
HISTCONTROL=ignorespace:erasedups

# append to the history file, don't overwrite it
# 2024-04-19 11:13:48 removed below line due to change in HISTCONTROL
# shopt -s histappend
# update after every command in every terminal
# export PROMPT_COMMAND='history -a;history -r;'

# https://www.gnu.org/software/bash/manual/html_node/Bash-Variables.html#index-HISTCMD
# A colon-separated list of values controlling how commands are saved on the
# history list. If the list of values includes ‘ignorespace’, lines which begin
# with a space character are not saved in the history list. A value of
# ‘ignoredups’ causes lines which match the previous history entry to not be
# saved. A value of ‘ignoreboth’ is shorthand for ‘ignorespace’ and
# ‘ignoredups’. A value of ‘erasedups’ causes all previous lines matching the
# current line to be removed from the history list before that line is saved.
# Any value not in the above list is ignored. If HISTCONTROL is unset, or
# does not include a valid value, all lines read by the shell parser are
# saved on the history list, subject to the value of HISTIGNORE. The second
# and subsequent lines of a multi-line compound command are not tested, and
# are added to the history regardless of the value of

# https://www.gnu.org/software/bash/manual/html_node/Bash-History-Facilities.html
HISTSIZE=10000
unset HISTFILESIZE
HISTIGNORE='history:pass'
# }}


# https://www.gnu.org/software/bash/manual/bash.html#The-Shopt-Builtin
# check the window size after each command and, if necessary,
# update the values of LINES and COLUMNS.

shopt -s checkwinsize

# If set, the pattern "**" used in a pathname expansion context will
# match all files and zero or more directories and subdirectories.
if [[ ${BASH_VERSINFO[0]} -ge 4 ]]; then
  shopt -s globstar
fi

# make less more friendly for non-text input files, see lesspipe(1)
[ -x /usr/bin/lesspipe ] && eval "$(SHELL=/bin/sh lesspipe)"

# set title of terminal window to user@hostname:pwd
# this shows up in prompt when using virtual terminal $TERM=Linux (tty)
# http://tldp.org/HOWTO/Xterm-Title-3.html
# http://stackoverflow.com/a/25535717/2472798
# pattern matching **requires** [[ ]]

# 1.2) Set up bash prompt{{ using starship
eval "$(starship init bash)"
# Set terminal title to current directory
set_terminal_title() {
    # Get the basename of current directory
    local dir_name="${PWD##*/}"
    # If in home directory, use ~
    [[ "$PWD" == "$HOME" ]] && dir_name="~"

    # Set title using OSC escape sequence
    echo -ne "\033]0;${dir_name}\007"
}
export starship_precmd_user_func="set_terminal_title"
# }}

#{{ Color chart
# Reset='\e[0m'    # Text Reset
# http://ethanschoonover.com/solarized
# http://ethanschoonover.com/solarized/img/solarized-palette.png
                   # SOLARIZED HEX     16/8 TERMCOL  XTERM/HEX   L*A*B      RGB         HSB
                   # --------- ------- ---- -------  ----------- ---------- ----------- -----------
# base02='\e[0;30m'  # base02    #073642  0/4 black    235 #262626 20 -12 -12   7  54  66 192  90  26
# red='\e[0;31m'     # red       #dc322f  1/1 red      160 #d70000 50  65  45 220  50  47   1  79  86
# green='\e[0;32m'   # green     #859900  2/2 green     64 #5f8700 60 -20  65 133 153   0  68 100  60
# yellow='\e[0;33m'  # yellow    #b58900  3/3 yellow   136 #af8700 60  10  65 181 137   0  45 100  71
# blue='\e[0;34m'    # blue      #268bd2  4/4 blue      33 #0087ff 55 -10 -45  38 139 210 205  82  82
# magenta='\e[0;35m' # magenta   #d33682  5/5 magenta  125 #af005f 50  65 -05 211  54 130 331  74  83
# cyan='\e[0;36m'    # cyan      #2aa198  6/6 cyan      37 #00afaf 60 -35 -05  42 161 152 175  74  63
# base2='\e[0;37m'   # base2     #eee8d5  7/7 white    254 #e4e4e4 92 -00  10 238 232 213  44  11  93
# base03='\e[1;30m'  # base03    #002b36  8/4 brblack  234 #1c1c1c 15 -12 -12   0  43  54 193 100  21
# orange='\e[1;31m'  # orange    #cb4b16  9/3 brred    166 #d75f00 50  50  55 203  75  22  18  89  80
# base01='\e[1;32m'  # base01    #586e75 10/7 brgreen  240 #585858 45 -07 -07  88 110 117 194  25  46
# base00='\e[1;33m'  # base00    #657b83 11/7 bryellow 241 #626262 50 -07 -07 101 123 131 195  23  51
# base0='\e[1;34m'   # base0     #839496 12/6 brblue   244 #808080 60 -06 -03 131 148 150 186  13  59
# violet='\e[1;35m'  # violet    #6c71c4 13/5 brmagenta 61 #5f5faf 50  15 -45 108 113 196 237  45  77
# base1='\e[1;36m'   # base1     #93a1a1 14/4 brcyan   245 #8a8a8a 65 -05 -02 147 161 161 180   9  63
# base3='\e[1;37m'   # base3     #fdf6e3 15/7 brwhite  230 #ffffd7 97  00  10 253 246 227  44  10  99
# color palette top row in gnome configure screen is 30-37 [0;30m
# color palette bottom row in gnome configure screen is bold 30-37 [1;30m
#}}
# {{ Virtual terminal tty colors
# https://acceptsocket.wordpress.com/2014/08/12/set-solarized-dark-as-default-color-scheme-for-linux-virtual-console/
# if [ $TERM = "linux" ]; then
#   echo -en "\e]P0073642" # base02    #073642  0
#   echo -en "\e]P8002b36" # base03    #002b36  8
#   echo -en "\e]P1dc322f" # red       #dc322f  1
#   echo -en "\e]P9cb4b16" # orange    #cb4b16  9
#   echo -en "\e]P2859900" # green     #859900  2
#   echo -en "\e]PA586e75" # base01    #586e75 10A
#   echo -en "\e]P3b58900" # yellow    #b58900  3
#   echo -en "\e]PB657b83" # base00    #657b83 11B
#   echo -en "\e]P4268bd2" # blue      #268bd2  4
#   echo -en "\e]PC839496" # base0     #839496 12C
#   echo -en "\e]P5d33682" # magenta   #d33682  5
#   echo -en "\e]PD6c71c4" # violet    #6c71c4 13D
#   echo -en "\e]P62aa198" # cyan      #2aa198  6
#   echo -en "\e]PE93a1a1" # base1     #93a1a1 14E
#   echo -en "\e]P7eee8d5" # base2     #eee8d5  7
#   echo -en "\e]PFfdf6e3" # base3     #fdf6e3 15F
#   clear #for background artifacting
# fi
#}}

# Colors {{
## Define any user-specific variables you want here.
# setup LS_COLORS for dircolors command. Solarize color pallette shows only greytones in terminal
# dircolors -b $HOME/.dircolors
LS_COLORS='rs=0:di=01;35:ln=00;36:mh=00:pi=40;33:so=40;33:do=40;33:bd=40;33;01:cd=40;33;01:or=40;31;01:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=00;32:*.tar=00;31:*.tgz=00;31:*.arj=00;31:*.taz=00;31:*.lzh=00;31:*.lzma=00;31:*.tlz=00;31:*.txz=00;31:*.zip=00;31:*.z=00;31:*.Z=00;31:*.dz=00;31:*.gz=00;31:*.lz=00;31:*.xz=00;31:*.bz2=00;31:*.bz=00;31:*.tbz=00;31:*.tbz2=00;31:*.tz=00;31:*.deb=00;31:*.rpm=00;31:*.jar=00;31:*.war=00;31:*.ear=00;31:*.sar=00;31:*.rar=00;31:*.ace=00;31:*.zoo=00;31:*.cpio=00;31:*.7z=00;31:*.rz=00;31:*.anx=00;34:*.asf=00;34:*.avi=00;34:*.axv=00;34:*.bmp=00;34:*.cgm=00;34:*.dl=00;34:*.emf=00;34:*.flc=00;34:*.fli=00;34:*.flv=00;34:*.gif=00;34:*.gl=00;34:*.jpeg=00;34:*.jpg=00;34:*.m2v=00;34:*.m4v=00;34:*.mkv=00;34:*.mng=00;34:*.mov=00;34:*.mp4=00;34:*.mp4v=00;34:*.mpeg=00;34:*.mpg=00;34:*.nuv=00;34:*.ogm=00;34:*.ogv=00;34:*.ogx=00;34:*.pbm=00;34:*.pcx=00;34:*.pdf=00;34:*.pgm=00;34:*.png=00;34:*.ppm=00;34:*.qt=00;34:*.rm=00;34:*.rmvb=00;34:*.svg=00;34:*.svgz=00;34:*.tga=00;34:*.tif=00;34:*.tiff=00;34:*.vob=00;34:*.webm=00;34:*.wmv=00;34:*.xbm=00;34:*.xcf=00;34:*.xpm=00;34:*.xwd=00;34:*.yuv=00;34:*.aac=00;35:*.au=00;35:*.flac=00;35:*.mid=00;35:*.midi=00;35:*.mka=00;35:*.mp3=00;35:*.mpc=00;35:*.ogg=00;35:*.opus=00;35:*.ra=00;35:*.wav=00;35:*.m4a=00;35:*.axa=00;35:*.oga=00;35:*.spx=00;35:*.xspf=00;35:';
export LS_COLORS

# From ubuntu 16.04 default bashrc
# colored GCC warnings and errors
export GCC_COLORS='error=01;31:warning=01;35:note=01;36:caret=01;32:locus=01:quote=01'

# === PATH Construction === {{
# Build PATH once at login to avoid duplication

# Helper function to add to PATH only if not present
pathmunge() {
    if [ -d "$1" ] && [[ ":$PATH:" != *":$1:"* ]]; then
        if [ "$2" = "after" ]; then
            PATH="$PATH:$1"
        else
            PATH="$1:$PATH"
        fi
    fi
}

#  - These are line by line so that you can kill one without affecting the others.
#  - Lowest priority first, highest priority last.
# https://www.gnu.org/software/bash/manual/bash.html#Pattern-Matching
# https://askubuntu.com/questions/299710/how-to-determine-if-a-string-is-a-substring-of-another-in-bash
# Prefixed to default PATH
# set PATH so it includes user's private bin if it exists
pathmunge "$HOME/.local/bin"
pathmunge "$HOME/bin"

# MacPorts Installer addition on 2019-08-11_at_09:59:35: adding an appropriate PATH variable for use with MacPorts.
# also set for Linux, use /opt/local instead of /usr/local
pathmunge /opt/local/bin
pathmunge /opt/local/sbin

# Appended to default PATH
# set PATH to include latest version of pandoc if installed via cabal
pathmunge "$HOME/.cabal/bin" after

# android studio manually installed in this location
pathmunge "$HOME/code/Android/android-studio/bin" after

# gem install --user-install uses this location
# ruby version replaced by *
gemloc=("$HOME"/.gem/ruby/*/bin)
pathmunge "${gemloc[0]}" after
unset gemloc

# yarn
pathmunge "$HOME/.yarn" after

# Golang
pathmunge "/opt/go/bin" after
pathmunge "$HOME/go/bin" after

# amdgpu
pathmunge /opt/amdgpu-pro/bin after
# rocm tools
pathmunge /opt/rocm/bin after

# dart https://dart.dev/get-dart
pathmunge /usr/lib/dart after

# Added by Windsurf
pathmunge "$HOME/.codeium/windsurf/bin" after

# pixi
pathmunge "${HOME}/.pixi/bin" after
# Java setup
pathmunge /usr/lib/jvm/jdk-19/bin after

# source path related files installed by these tools
# ==> Source [/opt/google-cloud-sdk/path.bash.inc] in your profile to add the Google Cloud SDK command line tools to your $PATH.
if [[ -r /opt/google-cloud-sdk/path.bash.inc ]]; then
  source /opt/google-cloud-sdk/path.bash.inc
fi

# Rust
[[ -d $HOME/.cargo ]] && source "$HOME/.cargo/env"

if [[ -d $HOME/.bun ]]; then
  # bun
  export BUN_INSTALL="$HOME/.bun"
  pathmunge "$BUN_INSTALL/bin" after
fi

if [[ "$OSTYPE" == "darwin"* ]]; then
  # add specific bash only environment (for anaconda mac)
  pathmunge /opt/bash/bin
  pathmunge /Library/Frameworks/Python.framework/Versions/Current/bin

  # added by Snowflake SnowflakeCLI installer v1.0
  pathmunge /Applications/SnowflakeCLI.app/Contents/MacOS/ after
  pathmunge /Applications/CMake.app/Contents/bin after

fi
#}}

#  2.0) Set up aliases {{
# -----------------------
# 2.0) My custom aliases
alias ping='ping -c 1'

# 2.1) Safety
alias rm='rm -i'
alias mv='mv -i'
alias cp='cp -i'
set -o noclobber

# 2.2) Listing, directories, and motion
alias ll='ls -Flha --color --ignore=lost+found --ignore=.Trash-1000'
# follow by -r to reverse sort order
alias lt='ls -Flhtr --color --ignore=lost+found --ignore=.Trash-1000'
alias l='ls -F --color --ignore=lost+found --ignore=.Trash-1000'
alias ..='cd ..'
alias md='mkdir'
alias rd='rmdir'
alias cl='clear'

# 2.3 Digital Ocean suggestions
# https://www.digitalocean.com/community/tutorials/an-introduction-to-useful-bash-aliases-and-functions
alias psa='ps auxf'
alias psg='ps auxf | grep -v grep | grep -i -e VSZ -e'

# 2.4 Custom aliases that I created
alias tree='tree -I node_modules -sh'
[[ $(command -v lsd) ]] && alias tree='lsd --tree --depth 1 --icon never -F'

# syntax colored cat replacement
[[ $(command -v bat) ]] && alias cat='bat'
# open files in graphic workspace based on mime-type
[[ $(command -v xdg-open) ]] && alias o='xdg-open'
alias mp='multipass'

# 2.4 Added for Comcast work
alias apb='ansible-playbook'
# 2.5 Docker
alias di='docker images'
# neovim test new config
alias nvim-kickstart='NVIM_APPNAME=nvim-kickstart nvim'
# kubectl
alias k='kubectl'

[[ $(command -v git-flow) ]] && alias gf='git-flow'
# You may want to put all your additions into a separate file like
# ~/.bash_aliases, instead of adding them here directly.
# See /usr/share/doc/bash-doc/examples in the bash-doc package.

if [ -f ~/.bash_aliases ]; then
    . ~/.bash_aliases
fi
# http://haacked.com/archive/2014/07/28/github-flow-aliases/
# TODO: create aliases for
# git clone --recursive (always want to recurse submodules)
# git pull --recurse-submodules (always want latest submodule)

# 2.3) Text and editor commands
alias e='nvim'
alias vv='gvim --remote-silent'
export EDITOR='nvim'
export VISUAL='nvim'
export MYVIMRC="$HOME/.config/nvim/init.lua"

# open terminal in current cwd
alias h='alacritty --working-directory $PWD --title $PWD'

# terminal pager
if command -v ov >/dev/null 2>&1
then
  alias more='ov'
  alias less='ov'
  export MANPAGER="ov --section-delimiter '^[^\s]' --section-header"
fi
#}}

# 2.5) sort options{{
# https://unix.stackexchange.com/questions/88201/whats-the-best-distro-shell-agnostic-way-to-set-environment-variables/88266#88266
# set in .pam_environment
# Ensures cross-platform sorting behavior of GNU sort.
# http://www.gnu.org/software/coreutils/faq/coreutils-faq.html#Sort-does-not-sort-in-normal-order_0021
# unset LC_ALL
# export LANG='en_US.UTF-8'
#}}


#{{ Node setup and tools
# [ -r file ] returns True if file exists and is readable.
[[ -d "$HOME/.config/nvm" ]] && export NVM_DIR="$HOME/.config/nvm"
[[ -r "$NVM_DIR/nvm.sh" ]] && source "$NVM_DIR/nvm.sh"  # This loads nvm

#}}

# {{ Python setup and tools
# https://howtopython.org/en/latest/the-interpreter/#bytecode-trick
# Python won't write *.pyc files to disk
export PYTHONDONTWRITEBYTECODE=1
export PYTEST_ADDOPTS="-vx --capture=tee-sys"
# }}

# Launchpad setup {{
export UBUMAIL="Antonios Hadjigeorgalis <Antonios@Hadji.co>"
export DEBEMAIL="Antonios@Hadji.co"
export DEBFULLNAME="Antonios Hadjigeorgalis"
# }}

#  git configuration {{
export GIT_AUTHOR_NAME="Antonios Hadjigeorgalis"
export GIT_COMMITTER_NAME="Antonios Hadjigeorgalis"

case "$HOSTNAME" in
  hadji|ubuntu12|debianT420s)
    export GIT_AUTHOR_EMAIL="Antonios@Hadji.co"
    export GIT_COMMITTER_EMAIL="Antonios@Hadji.co"
    ;;
  Antonioss-MacBook-Pro.local)
    export GIT_AUTHOR_EMAIL="ahadjigeorgalis@anaconda.com"
    export GIT_COMMITTER_EMAIL="ahadjigeorgalis@anaconda.com"
esac

# }}

# Darwin only setup {{
if [[ $(uname -s) == 'Darwin' ]]; then
  # add all mac osx specific bits inside an if statement like this.
  alias ll='ls -AFlhG'
  alias lt='ls -AFlhrtG'
  alias la='ls -AFG'
  alias l='ls -CFG'
  alias o='open'
  HISTSIZE=1000000
  HISTFILESIZE=1000000
  # http://stackoverflow.com/questions/1550288/os-x-terminal-colors
  export CLICOLOR=1
  export LSCOLORS=FxgxdadacxDaDahbadacec
  DOCKER_ROOT='/Applications/Docker.app/Contents/Resources/etc'
  if [[ -d $DOCKER_ROOT ]]; then
    . "$DOCKER_ROOT/docker.bash-completion"
    . "$DOCKER_ROOT/docker-compose.bash-completion"
  fi

  [[ -r "${HOME}/.iterm2_shell_integration.bash" ]] && source "${HOME}/.iterm2_shell_integration.bash"

  completion_files=(~/.config/dotfiles/bash/bash_completion)
  completion_files+=(~/.config/dotfiles/bash/000_bash_completion_compat.bash)
  if [[ -d /opt/homebrew/etc/bash_completion.d ]]; then
    completion_files+=(/opt/homebrew/etc/bash_completion.d/*)
  fi

  for f in "${completion_files[@]}"; do
    [[ -r $f  ]] && source "$f"
  done
fi
#}}



# bash functions {{
# https://www.gnu.org/software/bash/manual/bash.html#Shell-Functions

# custom behaviour when entering directory
cd () {
  builtin cd "$@" || return
  echo -e "\e]0;$(pwd)\a"
  activate
  # ls -F --color # linux only --ignore=lost+found
}

# activate python environments {{
# shellcheck disable=SC2120
activate() {
  if [[ -n "$1" ]]; then
    conda activate "$1"
  elif [[ -d .venv ]]; then
    source .venv/bin/activate
  # TODO: deactivate whene leaving virtual env
  # elif declare -F deactivate > /dev/null; then
  #   deactivate
  fi
}

# Define the completion function
_activate_function_completion() {
    local cur # prev words cword
    _init_completion || return

    mapfile -t COMPREPLY < <(compgen -d -- "$cur")
}

# Associate the completion function with your custom function
complete -o filenames -o nospace -F _activate_function_completion activate
# complete -o filenames -o nospace activate
#}}

#}}

# does a bashrc.local exist?
[[ -r $HOME/.bashrc.local ]] && source "$HOME/.bashrc.local"
# not frequently used, source when needed
# [[ -r $HOME/.bashrc.antlr ]] && source "$HOME/.bashrc.antlr"

# display that reboot is required after automatic update
if [ -r /var/run/reboot-required ]; then
  echo 'Reboot required'
  cat /var/run/reboot-required.pkgs
  uptime
fi

export TPM2_PKCS11_STORE=$HOME/.tpm2_pkcs11/

# ripgrep config https://github.com/BurntSushi/ripgrep/blob/master/GUIDE.md#configuration-file
export RIPGREP_CONFIG_PATH="$HOME/.config/ripgrep"

# Anaconda claude code setup {{
# using aws config [default]
# export AWS_PROFILE=Sandbox-621741996708
export AWS_REGION=us-east-1
export BEDROCK_AWS_REGION=$AWS_REGION
export CLAUDE_CODE_USE_BEDROCK=1
# https://us-east-1.console.aws.amazon.com/bedrock/home?region=us-east-1#/inference-profiles
export ANTHROPIC_MODEL='us.anthropic.claude-sonnet-4-5-20250929-v1:0'
export ANTHROPIC_DEFAULT_OPUS_MODEL='us.anthropic.claude-opus-4-5-20251101-v1:0'
export ANTHROPIC_DEFAULT_SONNET_MODEL='us.anthropic.claude-sonnet-4-5-20250929-v1:0'
export ANTHROPIC_DEFAULT_HAIKU_MODEL='us.anthropic.claude-haiku-4-5-20251001-v1:0'
# }}

# Setting fd as the default source for fzf
if command -v fd &> /dev/null; then
  export FZF_DEFAULT_COMMAND='fd --type f'
fi
# fzf setup
if [[ -f ~/.fzf.bash ]]; then
  source ~/.fzf.bash
else
  eval "$(fzf --bash)"
fi


# {{ bash completion
# https://superuser.com/questions/288714/bash-autocomplete-like-zsh
# https://www.gnu.org/software/bash/manual/html_node/Readline-Init-File-Syntax.html
# do 'bind -v' to see all variable names and values

# This alters the default behavior of the completion functions. If set to ‘on’,
# words which have more than one possible completion cause the matches to be
# listed immediately instead of ringing the bell. The default value is ‘off’.
bind 'set show-all-if-ambiguous on'
# If set to ‘on’, Readline displays possible completions using different colors
# to indicate their file type. The color definitions are taken from the value
# of the LS_COLORS environment variable. The default is ‘off’.
bind 'set colored-stats on'
# If set to ‘on’, completed names which are symbolic links to directories have
# a slash appended (subject to the value of mark-directories). The default is ‘off’.
bind 'set mark-symlinked-directories on'
bind 'TAB:menu-complete'

# Turn on bash command completion
[[ -r /usr/share/bash-completion/bash_completion ]] && source /usr/share/bash-completion/bash_completion

# enable bash_completion in local files {{

completion_files=(~/.local/share/bash-completion/completions/*)

for f in "${completion_files[@]}"; do
  # case "$f" in
  #   uv.bash)
  #     continue
  #     ;;
  # esac
  [[ -r $f  ]] && source "$f"
done

# _completion_loader()
# {
#     . "$HOME/.local/share/bash_completions.d/$1.sh" >/dev/null 2>&1 && return 124
# }
# complete -D -F _completion_loader -o bashdefault -o default

_complete_ssh_hosts ()
{
        COMPREPLY=()
        cur="${COMP_WORDS[COMP_CWORD]}"
        comp_ssh_hosts=$(cut -f 1 -d ' ' ~/.ssh/known_hosts | \
                        sed -e s/,.*//g | \
                        grep -v ^# | \
                        uniq | \
                        grep -v "\[" ;
                        grep "^Host " ~/.ssh/config | \
                        awk '{print $2}'
                )
        mapfile -t COMPREPLY < <(compgen -W "${comp_ssh_hosts}" -- "$cur")
        return 0
}
complete -F _complete_ssh_hosts ssh
# === Lazy Loading for Multiple Completions {{

# Define completion directory
# LAZY_COMPLETION_DIR="$HOME/.local/share/bash-completion/completions"
#
# # Lazy loader function
# _lazy_completion_loader() {
#     local cmd="$1"
#     local completion_file
#
#     # Try different file naming patterns
#     for pattern in "${cmd}.bash" "${cmd}" "_${cmd}"; do
#         completion_file="${LAZY_COMPLETION_DIR}/${pattern}"
#         if [ -f "$completion_file" ]; then
#             # Remove temporary completion
#             complete -r "$cmd" 2>/dev/null
#
#             # Source the real completion
#             source "$completion_file" 2>/dev/null && {
#                 # Try to call the real completion
#                 _completion_loader "$cmd" 2>/dev/null || return 0
#             }
#             return 0
#         fi
#     done
#
#     # If no completion file found, use default completion
#     return 1
# }

# Register lazy loading for specific commands
# for f in "${completion_files[@]}"; do
#   f="$(basename "$f")"
#   complete -F _lazy_completion_loader "${f%.*}"
# done
# TODO: this generates bash completion, how to use this instead of file
# uv generate-shell-completion bash
# }}

# === Lazy Loading for uv Completion {{

# Define the lazy loader for uv
# _uv_lazy_loader() {
#     # Remove the temporary completion
#     complete -r uv 2>/dev/null
#
#     # Source the actual completion file
#     if [ -f "$HOME/.local/share/bash-completion/completions/uv.bash" ]; then
#         source "$HOME/.local/share/bash-completion/completions/uv.bash" 2>/dev/null
#     fi
#
#     # Re-trigger completion with the now-loaded function
#     # COMP_WORDS and COMP_CWORD are set by bash
#     _completion_loader uv 2>/dev/null || return 0
# }
#
# # Register the lazy loader for uv only
# complete -F _uv_lazy_loader uv
# }}
# }}

# AWS CLI completion
# http://docs.aws.amazon.com/cli/latest/userguide/cli-command-completion.html
[[ $(command -v aws_completer) ]] && complete -C aws_completer aws

# nvm completion
[[ -r "$NVM_DIR/bash_completion" ]] && source "$NVM_DIR/bash_completion"
# kubectl completion
[[ $(command -v kubectl) ]] && source <(kubectl completion bash)
# allow completion to work with alias
complete -o default -F __start_kubectl k
# Notes:
# Create completion files for tools with these commands
# pip completion --bash
# npm completion
# https://github.com/git/git/blob/master/contrib/completion/git-completion.bash
# pandoc --bash-completion
#}}

# Linux specific config {{
if [[ $(uname -s) == Linux ]]; then
  # https://specifications.freedesktop.org/basedir-spec/basedir-spec-latest.html#variables
  export XDG_DATA_HOME=$HOME/.local/share
  export XDG_CONFIG_HOME=$HOME/.config
  export XDG_CACHE_HOME=$HOME/.cache
  # uv on machine with logical volumes
  export UV_LINK_MODE=copy
  # ollama config
  [[ -d /mnt/data/ollama ]] && export OLLAMA_MODELS=/mnt/data/ollama
  HOST_IP="$(hostname -I|awk '{print $1}')"
  export OLLAMA_HOST="${HOST_IP}:11434"
fi
#}}

# this is standard add from kiro install.  && returns false (failure code)
[[ "$TERM_PROGRAM" == "kiro" ]] && . "$(kiro --locate-shell-integration-path bash)"

# https://cryptography.io/en/latest/openssl/#legacy-provider-in-openssl-3-x
# anaconda-ai required env var
export CRYPTOGRAPHY_OPENSSL_NO_LEGACY=1
# llama-server env vars
# https://github.com/ggml-org/llama.cpp/blob/master/tools/server/README.md
# --jinja enabled by default according to docs, but not working as such with opencode
export LLAMA_ARG_JINJA=1
export LLAMA_ARG_CTX_SIZE=32768

# === Lazy-Loaded Conda Initialization ===
# This speeds up shell startup significantly
# Conda will initialize on first use of 'conda' command

# Lazy loading function for conda
if [ -d "$_CONDA_ROOT" ]; then
    __conda_lazy_init() {
        # Remove the lazy wrapper
        unset -f conda __conda_lazy_init

        # Initialize conda properly
        if __conda_setup="$("${_CONDA_ROOT}/bin/conda" 'shell.bash' 'hook' 2> /dev/null)"; then
            eval "$__conda_setup"
        else
            if [ -f "${_CONDA_ROOT}/etc/profile.d/conda.sh" ]; then
                . "${_CONDA_ROOT}/etc/profile.d/conda.sh"
            else
                export PATH="${_CONDA_ROOT}/bin:$PATH"
            fi
        fi
        unset __conda_setup

        # Call conda with original arguments
        conda "$@"
    }

    # Create conda alias that triggers lazy loading
    conda() {
        __conda_lazy_init "$@"
    }
fi




# gh cli completion
# eval "$($HOME/Code/gitapi/git_env/bin/gh completion -s bash)"

# >>> nvwb
# Sourcing the nvwb wrapper function was added during the NVIDIA AI Workbench installation and
# is required for NVIDIA AI Workbench to function properly. When uninstalling
# NVIDIA AI Workbench, it will be removed.
if [ -f "$HOME/.local/share/nvwb/nvwb-wrapper.sh" ]; then
    source "$HOME/.local/share/nvwb/nvwb-wrapper.sh"
fi
# >>> nvwb

eval "$(/opt/homebrew/bin/brew shellenv)"

# Added by Antigravity
export PATH="/Users/ahadjigeorgalis/.antigravity/antigravity/bin:$PATH"

# profile stop time start {{
if [[ $DEBUG == 1 ]]; then
  set +x
  exec 2>&3 3>&-
fi
# }}

# : is bash builtin that does nothing and always returns 0
:


# Kiro CLI post block. Keep at the bottom of this file.
[[ -f "${HOME}/Library/Application Support/kiro-cli/shell/bashrc.post.bash" ]] && builtin source "${HOME}/Library/Application Support/kiro-cli/shell/bashrc.post.bash"
